<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spatial Internet Graph Relay</title>
  <link rel="stylesheet" href="/static/styles.css">
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  {% if google_analytics_id is defined and google_analytics_id %}
  <script async src="https://www.googletagmanager.com/gtag/js?id={{ google_analytics_id }}"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', '{{ google_analytics_id }}');
  </script>
  {% endif %}
</head>
<body>
  <div id="session-notification" class="session-notification"></div>

  <header>
    <nav>
      <a href="/" class="nav-brand">üåê SIGR</a>
      <div class="nav-links">
        <a href="/" class="active">Home</a>
        <a href="/worlds">Worlds</a>
        <a href="/relays">Relays</a>
      </div>
    </nav>
  </header>
  
  <main>
    <section class="hero-section">
      <h1 class="hero-title">Zesty Relay</h1>
      <p class="hero-subtitle">
        Discover and explore spatial experiences on the web. Connect to immersive 3D worlds, 
        virtual spaces, and interactive applications through our distributed relay network.
      </p>
      <div class="stats-container">
        <div class="stat-item">
          <span class="stat-number">{{ apps_count }}</span>
          <span class="stat-label">Worlds Explored</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="total-users-online">{{ total_users_online }}</span>
          <span class="stat-label">Users Online</span>
        </div>
      </div>
      <p style="margin-top: 2rem;">
        <a href="https://docs.zesty.xyz/graph/overview" target="_blank" rel="noopener noreferrer" 
           style="color: #667eea; text-decoration: none; font-weight: 600;">
          üìö Learn more about the Spatial Internet Graph ‚Üí
        </a>
      </p>
    </section>

    <section class="search-container">
      <input type="text" class="search-box" placeholder="üîç Search spatial experiences..." 
             oninput="searchApps(this.value)">
    </section>

    <section class="tiles">
      {% for app in apps %}
      {% if app.url is starting_with("https") or app.url is starting_with("http") %}
        {% set adjusted_url = app.url %}
      {% else %}
        {% set adjusted_url = "https://" ~ app.url %}
      {% endif %}
      <div class="tile" data-name="{{ app.name | lower }}" data-url="{{ app.url }}" onclick="window.location.href='{{ app.page_path }}'">
        <div class="tile-content">
          <img src="{{ app.image }}" class="tile-image" alt="{{ app.name }}" onerror="this.src='/static/images/noimage.png'">

          <h3 class="tile-title">{{ app.name }}</h3>

          <div class="live-count-container">
            <div class="live-dot"></div>
            <p class="live-count-text">{{ app.live_count }} here now</p>
          </div>

          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center;">
            <a href="{{ adjusted_url }}" target="_blank" rel="noopener noreferrer" class="tile-button"
               onclick="event.stopPropagation();">
              Launch
            </a>
            <a href="{{ app.page_path }}" class="tile-button" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);"
               onclick="event.stopPropagation();">
              Details
            </a>
          </div>
        </div>
      </div>
      {% endfor %}
    </section>

    <section class="community-section">
      <div class="community-content">
        <h2 class="community-title">Stay in the Loop</h2>
        <p class="community-subtitle">Get weekly spatial picks</p>

        <div class="community-actions">
          <a href="https://zesty.substack.com/embed" target="_blank" rel="noopener noreferrer" class="community-button email-button">
            üìß Subscribe to Weekly Picks
          </a>
          <a href="https://discord.gg/4tcveDjBuD" target="_blank" rel="noopener noreferrer" class="community-button discord-button">
            üí¨ Join the Discord
          </a>
        </div>
      </div>
    </section>
  </main>

  <footer class="publisher-footer">
    <p>Building spatial experiences? <a href="https://zesty.market" target="_blank" rel="noopener noreferrer">Monetize with Zesty ‚Üí</a></p>
  </footer>

  <script>
    function searchApps(query) {
      const tiles = document.querySelectorAll('.tile');
      const searchTerm = query.toLowerCase().trim();

      tiles.forEach(tile => {
        const appName = tile.dataset.name;
        const isVisible = !searchTerm || appName.includes(searchTerm);
        tile.style.display = isVisible ? 'block' : 'none';
      });
    }

    // Sync counts from API (fallback, runs less frequently)
    function syncLiveCounts() {
      fetch('/api/apps')
        .then(res => res.json())
        .then(data => {
          const totalEl = document.getElementById('total-users-online');
          if (totalEl) totalEl.textContent = data.total_users_online;

          const countsByUrl = {};
          data.apps.forEach(app => countsByUrl[app.url] = app.live_count);

          document.querySelectorAll('.tile').forEach(tile => {
            const url = tile.dataset.url;
            const countEl = tile.querySelector('.live-count-text');
            if (countEl && url in countsByUrl) {
              countEl.textContent = countsByUrl[url] + ' here now';
            }
          });
        })
        .catch(() => {});
    }

    // Real-time updates via SSE
    (function() {
      const banner = document.getElementById('session-notification');
      let timeout;

      const sse = new EventSource('/events/sessions');
      sse.onmessage = function(e) {
        try {
          const data = JSON.parse(e.data);
          banner.textContent = `Someone just joined ${data.app_name}`;
          banner.classList.add('visible');
          clearTimeout(timeout);
          timeout = setTimeout(() => banner.classList.remove('visible'), 5000);

          // Increment count locally (no API call needed)
          const totalEl = document.getElementById('total-users-online');
          if (totalEl) totalEl.textContent = parseInt(totalEl.textContent || 0) + 1;

          // Find matching tile by name and increment its count
          const appNameLower = data.app_name.toLowerCase();
          document.querySelectorAll('.tile').forEach(tile => {
            if (tile.dataset.name === appNameLower) {
              const countEl = tile.querySelector('.live-count-text');
              if (countEl) {
                const current = parseInt(countEl.textContent) || 0;
                countEl.textContent = (current + 1) + ' here now';
              }
            }
          });
        } catch (err) {}
      };
    })();

    // Sync every 30 seconds as fallback (handles users leaving, corrections)
    setInterval(syncLiveCounts, 30000);
  </script>
</body>
</html>