<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apps List - SIGR</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script src="https://kit.fontawesome.com/0df6185928.js" crossorigin="anonymous"></script>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
  <div id="session-notification" class="session-notification"></div>

  <header>
    <nav>
      <a href="/" class="nav-brand">üåê SIGR</a>
      <div class="nav-links">
        <a href="/">Home</a>
        <a href="/apps" class="active">Apps</a>
        <a href="/relays">Relays</a>
      </div>
    </nav>
  </header>
  
  <main>
    <section class="hero-section">
      <h1 class="hero-title">All Applications</h1>
      <p class="hero-subtitle">Browse spatial experiences and applications in our network</p>
    </section>

    <section class="search-container">
      <input type="text" class="search-box" placeholder="üîç Search applications..." 
             oninput="searchApps(this.value)">
      <div style="margin-top: 1rem;">
        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
          <input id="adult" type="checkbox" onchange="filterAdultApps()" style="transform: scale(1.2);">
          Show apps with 18+ content
        </label>
      </div>
    </section>
  <div class="list-container">
    {% for appgroup in apps %}
      {% set domain = domains[loop.index0] %}
      {% set_global has_visible = false %}
      {% for app in appgroup %}
        {% if (DEBUG or ("localhost" not in app.url)) and (SHOW_ADULT_CONTENT or not app.adult) and app.visible %}
          {% set_global has_visible = true %}
          {% break %}
        {% endif %}
      {% endfor %}

      {% if has_visible %}
      <details class="app-container" data-domain="{{ domain | lower }}">
        <summary>{{ domain }}</summary>
        {% for app in appgroup %}
          {% if (DEBUG or ("localhost" not in app.url)) and (SHOW_ADULT_CONTENT or not app.adult) and app.visible %}
            {% if app.url is starting_with("https") or app.url is starting_with("http") %}
              {% set adjusted_url = app.url %}
            {% else %}
              {% set adjusted_url = "https://" ~ app.url %}
            {% endif %}
            <div class="card" data-url="{{ adjusted_url }}" data-adult="{{ app.adult }}" data-tags="{{ app.tags }}" data-visible="{{ app.visible }}" data-name="{{ app.name | lower }}">

              <div class="app-header">
                <h3 class="app-title">{{ app.name }}</h3>
                <div class="app-genres">
                  {% if 'action' in app.tags %}
                    <i class="genre fa-solid fa-hand-fist" aria-hidden="true" title="Action"></i>
                  {% endif %}
                  {% if 'horror' in app.tags %}
                    <i class="genre fa-solid fa-ghost" aria-hidden="true" title="Horror"></i>
                  {% endif %}
                  {% if 'rpg' in app.tags %}
                    <i class="genre fa-solid fa-dice-d20" aria-hidden="true" title="RPG"></i>
                  {% endif %}
                  {% if ('music' in app.tags) or ('rhythm' in app.tags) %}
                    <i class="genre fa-solid fa-music" aria-hidden="true" title="Music/Rhythm"></i>
                  {% endif %}
                  {% if ('puzzle' in app.tags) or ('strategy' in app.tags) %}
                    <i class="genre fa-solid fa-puzzle-piece" aria-hidden="true" title="Puzzle/Strategy"></i>
                  {% endif %}
                </div>
              </div>

              <p class="app-description">{{ app.description }}</p>

              <p class="app-indexed" style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">
                Indexed: {{ app.created_at | date(format="%b %d, %Y") }}
              </p>

              <div class="app-actions">
                <a href="{{ adjusted_url }}" target="_blank" rel="noopener noreferrer">
                  <button type="button">üöÄ Launch App</button>
                </a>

                <a href="{{ app_pages[app.url] }}" rel="noopener noreferrer">
                  <button type="button">‚ÑπÔ∏è Details</button>
                </a>
              </div>

            </div>
          {% endif %}
        {% endfor %}
      </details>
      {% endif %}
    {% endfor %}
  </div>
  </main>

  <script>
    const adult = document.querySelector('#adult');

    function searchApps(query) {
      const cards = document.querySelectorAll('.card');
      const groups = document.querySelectorAll('.app-container');
      const searchTerm = query.toLowerCase().trim();

      cards.forEach(card => {
        const appName = card.dataset.name || '';
        const appDescription = card.querySelector('p')?.textContent.toLowerCase() || '';
        const isVisible = !searchTerm ||
          appName.includes(searchTerm) ||
          appDescription.includes(searchTerm);
        card.style.display = isVisible ? 'block' : 'none';
      });

      // Hide empty groups and show groups that match domain search
      groups.forEach(group => {
        const domain = group.dataset.domain || '';
        const visibleCards = group.querySelectorAll('.card:not([style*="none"])').length;
        const domainMatches = !searchTerm || domain.includes(searchTerm);

        if (domainMatches && searchTerm) {
          // If searching by domain, show all cards in matching groups
          group.querySelectorAll('.card').forEach(card => card.style.display = 'block');
          group.style.display = 'block';
        } else {
          group.style.display = visibleCards > 0 ? 'block' : 'none';
        }
      });
    }

    function filterAdultApps() {
      const cardsList = document.querySelectorAll("details[data-adult]")
      const appsList = document.querySelectorAll("div[data-adult]")
      for (const app of appsList) {
        const isAdult = app.getAttribute('data-adult');
        if (isAdult == "true") {
          app.style.display = adult.checked ? 'block' : 'none';
          if (app.parentNode.childElementCount == 2) {
            app.parentElement.style.display = app.style.display;
          }
        }
      }
    }

    // Filter out apps initially on page load
    filterAdultApps();

    // Real-time notifications when users join apps
    (function() {
      const banner = document.getElementById('session-notification');
      let timeout;

      const sse = new EventSource('/events/sessions');
      sse.onmessage = function(e) {
        try {
          const data = JSON.parse(e.data);
          banner.textContent = `Someone just joined ${data.app_name}`;
          banner.classList.add('visible');
          clearTimeout(timeout);
          timeout = setTimeout(() => banner.classList.remove('visible'), 5000);
        } catch (err) {}
      };
    })();
  </script>
</body>
</html>