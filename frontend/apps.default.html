<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apps List</title>
  <link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css">
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <header>
    <nav>
      <a href="/">Home</a>
      <a href="/apps">List of Apps</a>
      <a href="/relays">List of Relays</a>
    </nav>
  </header>
  <h1>Apps List</h1>
  <div>
    <br>
    {% if SHOW_ADULT_CONTENT %}
    <input id="adult" type="checkbox" onchange="filterAdultApps()">Show apps with 18+ content?</input>
    {% endif %}
  </div>
  <hr>
  <label for="search">Search</label>
  <input id="search" type="text" oninput="searchApps()">
  <div class="list-container">
  {% for appgroup in apps %}
    <details class="app-container">
      <summary>{{ appgroup[0].name }}</summary>
      {% for app in appgroup %}
        {% if (DEBUG or ('localhost' not in app.url)) and (SHOW_ADULT_CONTENT or not app.adult) and app.visible %}
        <div class="card" data-url="{{ app.url }}" data-adult="{{ app.adult }}" data-tags="{{ app.tags }}">

          <a href="{{ app_pages[app.url] }}" target="_blank" rel="noopener noreferrer">{{ app.name }}</a>
          <p>{{ app.description }}</p>
          <a href="{{ app.url | safe }}" target="_blank" rel="noopener noreferrer">{{ app.url }}</a>
        </div>
        {% endif %}
      {% endfor %}
    </details>
  {% endfor %}
  </div>
  <script>
    const appsList = document.querySelector('.list-container');
    /** @type {HTMLInputElement} */
    const search = document.querySelector('#search');
    /** @type {HTMLInputElement} */
    const adult = document.querySelector('#adult');

    function filterApps(checkbox) {
      const checked = checkbox.checked;
      const hostURL = checkbox.getAttribute('data-url');
      for (const app of appsList.children) {
        const url = app.getAttribute('data-url');
        if (url.includes(hostURL) && !url.includes(`.${hostURL}`)) {
          app.style.display = checked ? 'block' : 'none';
          if (!checked)
            app.setAttribute('data-url-filtered', "");
          else
            app.removeAttribute('data-url-filtered');
        }
      }
      searchApps();
      filterAdultApps();
    }

    function filterAdultApps() {
      for (const app of appsList.children) {
        if (app.hasAttribute('data-url-filtered')) continue;

        const isAdult = app.getAttribute('data-adult');
        if (isAdult == "true") {
          app.style.display = adult.checked ? 'block' : 'none';
        }
      }
    }

    /**
     * Very basic filter search that checks for the term in the app card HTML
     */
    function searchApps() {
      for (const app of appsList.children) {
        if (app.hasAttribute('data-url-filtered')) continue;

        if (app.innerHTML.toLowerCase().includes(search.value)) {
          app.style.display = 'block';
        } else {
          console.log(app.innerHTML);
          app.style.display = 'none';
        }
      }

      filterAdultApps();
    }

    // Filter out
    filterAdultApps();
  </script>
</body>
</html>